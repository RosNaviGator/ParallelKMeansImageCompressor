/**
 * @file decoder.cpp
 * @brief The main program for decoding .kc files generated by the Encoder.
 * @details This program provides a command-line interface for decoding images that have been compressed by the Encoder.
 *          It allows users to load a compressed image, convert it to a viewable format, and optionally save it as a .jpg file.
 *          The program makes use of OpenCV for image processing and the custom filesUtilsand utilsCLI libraries for handling file
 *          operations and user interactions.
 *          The Decoder program reads a .kc compressed file, decodes it into an image matrix, converts the color space for display,
 *          and allows the user to save a decompressed copy as a .jpg image. The program provides a simple command-line interface for
 *          selecting files and configuring output options.
 */

#include <opencv2/opencv.hpp>
#include <iostream>
#include <vector>
#include <string>
#include <fstream>
#include <sstream>
#include <cmath>
#include <cstdint>
#include <filesystem>
#include <filesUtils.hpp>
#include <utilsCLI.hpp>

using namespace km;
using namespace km::filesUtils;
using namespace km::utilsCLI;

/**
 * @brief Main function for the Decoder program.
 * @details This function initializes the Decoder program, presents a menu for selecting the compressed image file, decodes
 *          the selected file, converts it for display, and provides the option to save the decoded image as a .jpg file.
 *
 * @return Returns 0 on successful execution.
 */

auto main() -> int
{
    decoderHeader();
    std::cout << "This is the Decoder to decode the .kc file generated by the Encoder, if you haven't already compressed a file by the Encoder this Decoder is not so useful" << std::endl;
    std::cout << std::endl;
    std::cout << std::endl;
    std::string path = "";
    createOutputDirectories();
    std::filesystem::path decodeDir;
    std::vector<std::filesystem::path> imageNames;
    createDecodingMenu(decodeDir, imageNames);
    displayDecodingMenu(path, imageNames, decodeDir);
    std::cout << std::endl;
    std::cout << std::endl;
    // std::getline(std::cin, path); 
    std::cout << std::endl;
    std::string answer = "d";
    while (answer != "y" && answer != "n")
    {
        decoderHeader();
        std::cout << "Do you want to save a copy .jpg of your Compressed Image? [y/n]"<< std::endl;
        std::cout << std::endl;
        std::cout << std::endl;
        std::cin >> answer;
    }

    cv::Mat imageCompressed; 

    if (readBinaryFile(path, imageCompressed) == 1)
    {
        std::cerr << "Error reading the file." << std::endl;
        return 1;
    }

    cv::cvtColor(imageCompressed, imageCompressed, cv::COLOR_YCrCb2BGR);

    if(answer == "y")
    {
        if (path.length() >= 3) {
        // Rimuovi gli ultimi 3 caratteri dalla stringa
        path.erase(path.length() - 3);
        }
        std::string outputPath = path + std::string(".jpg");
        cv::imwrite(outputPath, imageCompressed);
    }
    workDone();
    std::cout << "Enjoy your Compressed Image!" << std::endl;
    cv::imshow("Compressed Image", imageCompressed);
    cv::waitKey(0);
}